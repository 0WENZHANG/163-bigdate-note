## Azkaban编译

Azkaban：调度系统框架，[下载地址](https://github.com/azkaban/azkaban.git).

Azkaban-Plugins：具体插件的实现，包括Yarn On Hadoop的安全认证模块，[下载地址](https://github.com/azkaban/azkaban-plugins.git)

### 编译环境准备

> jdk 版本 >= 1.8

> ant：编译打包管理工具，对标maven

> NodeJs, dustjs：nodejs是js运行环境，web插件编译的时候需要用到，dustjs是开源js模板框架，二者都是用于plugins的编译打包

> gradle：java工程的编译打包工具，azkaban中自带，不需要额外编译。

### Azkaban编译环境安装

1. java

    使用openjdk

    ```conf
    export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk
    export PATH=$JAVA_HOME/bin:$PATH
    export CLASSPATH=$JAVA_HOME/lib/*:$CLASSPATH
    ```

2. ant

    - [下载地址](https://mirrors.tuna.tsinghua.edu.cn/apache/ant/binaries/apache-ant-1.9.13-bin.tar.gz)，这个地址是中文镜像地址，下载速度会快一些，版本为1.9.13

    - 解压到将ant指定文件夹，我是将解压出来的ant放到自己home目录下的apps这个目录下了（/mnt/home/1015146591/apps）

        ```
        tar xzvf apache-ant-1.9.13-bin.tar.gz -C ../apps/
        ```

    - 配置ant到环境变量

        ```conf
        # ANT
        export ANT_HOME=/mnt/home/1015146591/apps/apache-ant-1.9.13
        export PATH=$ANT_HOME/bin:$PATH
        ```

    - source生效

        ```
        source ~/.bashrc
        ```

3. NodeJs（跳过），不需要安装

4. Gradle，azkaban项目自带

5. git，视具体操作系统而定。

### Azkaban目录结构

```
[1015146591@bigdata4 azkaban-master]$ tree -L 1
.
├── az-core
├── az-crypto
├── az-examples
├── az-exec-util
├── az-flow-trigger-dependency-plugin
├── az-flow-trigger-dependency-type
├── az-hadoop-jobtype-plugin
├── az-hdfs-viewer
├── az-intellij-style.xml
├── az-jobsummary
├── azkaban-common                          //基础模块
├── azkaban-db
├── azkaban-exec-server
├── azkaban-hadoop-security-plugin
├── azkaban-solo-server
├── azkaban-spi
├── azkaban-web-server
├── az-reportal
├── build.gradle
├── CONTRIBUTING.md
├── docs
├── gradle
├── gradle.properties
├── gradlew
├── gradlew.bat
├── LICENSE
├── NOTICE
├── README.md
├── requirements.txt
├── settings.gradle
├── test
└── tools
```

模块之间的依赖关系：

![依赖关系][1]

- azkaban-common：定义了基础数据结构和接口的实现。

- azkaban-web-server：webserver模块

- azkaban-exec-server：executor模块

- azkaban-db：数据库模块，封装了数据库的访问的建表sql语句

- 其他几个模块是插件代码，这里存在插件代码的原因是现在的插件项目代码维护比较麻烦，因此将代码同步到了azkaban项目中，在以后编译azkaban-pligins的时候如果遇到缺少类的情况，就可以到azkaban项目中进行查找。

### azkaban编译配置文件修改

配置文件： /mnt/home/1015146591/apps/azkaban/azkaban-master/build.gradle

1. 修改hadoop依赖的版本

    ```
    ext.versions = [
            hadoop: '2.7.6',
            hive  : '1.1.0',
            pig   : '0.11.0',
            restli: '1.15.7',
            slf4j : '1.7.18',
    ]
    ```

2. 向build.gradle中增加yarn相关依赖

    ```
    ext.deps = [
            // External dependencies
            yarnapi             : "org.apache.hadoop:hadoop-yarn-api:${versions.hadoop}",
            yarncommon          : "org.apache.hadoop:hadoop-yarn-common:${versions.hadoop}",
            yarnclient          : "org.apache.hadoop:hadoop-yarn-client:${versions.hadoop}",

            assertj             : 'org.assertj:assertj-core:3.8.0',
            awaitility          : 'org.awaitility:awaitility:3.0.0',
            collections         : 'commons-collections:commons-collections:3.2.2',

    ```

3. 在exec/build.properties中增加hadoop/yarn依赖

    ```
    dependencies {
        ...
        compile deps.hadoopCommon
        compile deps.hadoopHdfs
        compile deps.yarnapi
        compile deps.yarncommon
        compile deps.yarnclient
        ...
    }
    ```

4. repositories参数调整，用于配置maven仓库地址，提高下载速度

    ```
    repositories {
        mavenCentral()
        maven {
            //url 'https://plugins.gradle.org/m2/'
            url 'http://maven.aliyun.com/nexus/content/groups/public/'
        }
    }
    ```

5. 编译

    正常编译：

    ```
    ./gradlew build
    ```

    跳过单元测试：
    ```
    ./gradlew build -x test
    ```

    web发布包：azkaban-web-server/build/distributions目录下

    Exec发布包：azkaban-exec-server/build/distributions

    solo模式发布包：azkaban-solo-server/build/distributions

    部署模式：1，solo；2，单机；3，集群

###

[1]: https://github.com/jiaoqiyuan/163-bigdate-note/raw/master/%E5%A4%A7%E6%95%B0%E6%8D%AE%E8%B0%83%E5%BA%A6%E6%A1%86%E6%9E%B6%EF%BC%9AAzkaban/img/azkaban_directory.png
