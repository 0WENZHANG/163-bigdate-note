## Storm 架构

Storm 架构可以类比为公司中人员关系，如下图所示。

![1](https://github.com/jiaoqiyuan/pics/raw/master/sxt/Storm-structure.png)

- Storm 的架构类似于 Hadoop，是主从模型(Master/Slave)。

- 其中 Numbus 是主节点，负责任务(Task)的调度和资源分配。

- Supervisor 是从节点，是负责执行任务的具体部分，启动和停止自己管理的 Worker 进程。

    Supervisor 中有具体执行 task 的 Worker。其中 task 对应的就是 Spout 和 Bolt。

    Supervisor 可以启动多个 Worker， 具体启动多少个可以配置。
    
    一个 Topology 可以运行在多个 Worker 上，也可以通过配置来指定。

- Storm 中各个节点是无状态的，节点上的信息(元数据)会存储到 Zookeeper 中。

- Worker 是运行具体组件逻辑(Spout/Bolt)的进程。

以下都是线程，以上都是进程。

- Task 是 Spout 和 Bolt 线程的统称。

- executor：Spout 和 Bolt 可能会共享一个线程。

- Storm 调优的关键是设置好一个 Topology 启动多少个 Worker， 一个Worker上启动多少个 executor， 然后一个 executor 启动多少个 Task。

## Storm 安装

### 单机版 Storm

1. 下载并解压 Storm1.2.2 ：[点击这里](https://www-us.apache.org/dist/storm/apache-storm-1.2.2/apache-storm-1.2.2.tar.gz)。

    ```
    [root@node01 ~]# wget https://www-us.apache.org/dist/storm/apache-storm-1.2.2/apache-storm-1.2.2.tar.gz

    [root@node01 ~]# tar xzvf ~/apache-storm-1.2.2.tar.gztar.gz -C /opt/sxt/
    ```

2. 添加 Storm 到系统环境变量:

    ```
    # Storm
    export STORM_HOME=/opt/sxt/storm-1.2.2
    export PATH=$STORM_HOME/bin:$PATH
    ```

    ```
    [root@node01 storm-1.2.2]# source /etc/profile
    ```

3. 配置 Strom

    配置 JAVA_HOME :

    ```
    export JAVA_HOME=/opt/sxt/jdk1.8.0_201
    ```

4. 启动 Storm ：

    Storm 部分参数配置：

        dev-zookeeper 启动 ZK
        numbus 启动主节点
        supervisor：启动从节点
        ui：启动界面
        logviewer：启动日志查看服务。

    前台启动 zookeeper ：

    ```
    storm dev-zookeeper
    ```

    在 bin/ 目录下后台启动 `zookeeper`：

    ```
    [root@node01 bin]# nohup sh storm dev-zookeeper &
    ```

    在 bin/ 目录下后台启动 `nimbus`：

    ```
    [root@node01 bin]# nohup sh storm nimbus &
    ```

    启动 storm 的 `UI`：

    ```
    [root@node01 bin]# nohup sh storm ui &
    ```

    在浏览器输入 `http://node01:8080` 查看 Storm UI.

    后台启动 `supervisor`：

    ```
    [root@node01 bin]# nohup sh storm supervisor &
    [root@node01 bin]# jps
    1824 dev_zookeeper
    2114 core
    1927 nimbus
    2346 Jps
    2252 Supervisor
    ```

    后台启动 `logviewer`：

    ```
    [root@node01 bin]# nohup sh storm logviewer &
    [root@node01 bin]# jps
    1824 dev_zookeeper
    2496 Jps
    2114 core
    1927 nimbus
    2252 Supervisor
    2398 logviewer
    ```

5. 提交作业到集群运行：

    先打包程序并上传到集群上。

    使用 strom 运行 jar：

    ```
    [root@node01 bin]# storm jar /root/jars/storm-1.0-SNAPSHOT.jar com.imooc.bigdata.ClusterSumStormTopology
    ```

    在网页端 `http://node01:8000` 可以查看相信信息。

6. Storm 其他命令的使用

    查看当前正在跑的 Topology：

    ```
    storm list
    ```

    停止作业，可以通过 UI 的方式：

    ```
    Topology Summary -> ClusterSumStormTopology -> Topology actions -> kill
    ```

    通过命令行停止作业：

    ```
    storm kill ClusterSumStormTopology
    ```

    通过 kill 杀死其他 storm 进程：


    ```
    [root@node01 bin]# jps
    1824 dev_zookeeper
    2114 core
    1927 nimbus
    2252 Supervisor
    3038 Jps
    2398 logviewer
    [root@node01 bin]# kill -9 1824 2114 1927 2252 2398
    [root@node01 bin]# jps
    3048 Jps
    [1]   Killed                  nohup sh storm dev-zookeeper
    [2]   Killed                  nohup sh storm nimbus
    [3]   Killed                  nohup sh storm ui
    [4]-  Killed                  nohup sh storm supervisor
    [5]+  Killed                  nohup sh storm logviewer
    [root@node01 bin]# jps
    3058 Jps
    [root@node01 bin]# 
    ```

## Storm 集群搭建

1. 部署规划：

    |        | NN-1 | NN-2 | DN | ZK | ZKFC | JNN | RS | NM | Nimbus(ui) | Supervisor(logviewer) | 
    |:------:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|:-:|
    | node01 | * |   |   |   | * | * |   |   | * | * |
    | node02 |   | * | * | * | * | * |   | * |   | * |
    | node03 |   |   | * | * |   | * | * | * |   | * |
    | node04 |   |   | * | * |   |   | * | * |   |   |

2. 拷贝 strom 文件夹到 node02/node03 上：

    ```
    [root@node01 sxt]# scp -r storm-1.2.2/ root@node02:`pwd`
    [root@node01 sxt]# scp -r storm-1.2.2/ root@node03:`pwd`
    ```

3. 配置 node02/node03 的环境变量：

    ```
    # Storm
    export STORM_HOME=/opt/sxt/storm-1.2.2
    export PATH=$STORM_HOME/bin:$PATH
    ```

    ```
    [root@node02 sxt]# source /etc/profile
    [root@node03 sxt]# source /etc/profile
    ```

4. 修改 Storm `storm.yaml` 配置文件：

    ```
    storm.zookeeper.servers:
        - "node02"
        - "node03"

    storm.local.dir: "/var/sxt/storm"

    supervisor.slots.ports:
        - 6700
        - 6701
        - 6702
        - 6703

    nimbus.seeds: ["node01"]
    ```

5. 拷贝配置文件到 node02/node03：

    ```
    [root@node01 conf]# scp storm.yaml root@node02:`pwd`
    [root@node01 conf]# scp storm.yaml root@node03:`pwd`
    ```

6. 启动

    启动 Nimbus：

    ```
    [root@node01 bin]# nohup sh storm nimbus &
    [root@node01 bin]# jps
    1682 nimbus
    1817 Jps
    ```

    启动 ui：

    ```
    [root@node01 bin]# nohup sh storm ui &
    [root@node01 bin]# jps
    1682 nimbus
    1965 Jps
    1869 core
    ```

    在 node01/node02/node03 上启动 supervisor 和 logviewer：

    ```
    [root@node01 bin]# nohup sh storm supervisor &
    [root@node01 bin]# nohup sh storm logviewer &
    [root@node01 bin]# jps
    1682 nimbus
    2134 logviewer
    1997 Supervisor
    1869 core
    2255 Jps

    [root@node02 bin]# nohup sh storm supervisor &
    [root@node02 bin]# nohup sh storm logviewer &
    [root@node02 bin]# jps
    1698 QuorumPeerMain
    2067 Jps
    1845 Supervisor
    1979 logviewer

    [root@node03 bin]# nohup sh storm supervisor &
    [root@node03 bin]# nohup sh storm logviewer &
    [root@node03 bin]# jps
    1777 Jps
    1554 Supervisor
    1668 logviewer
    1288 QuorumPeerMain
    ```

7. 提交作业到分布式 Storm 集群运行

    ```
    [root@node01 bin]# storm jar /root/jars/storm-1.0-SNAPSHOT.jar com.imooc.bigdata.ClusterSumStormTopology
    ```